# Review: remote-daemon.sh

> Reviewed: 2026-01-24
> Original: dotclaude/scripts/remote/remote-daemon.sh

## 概要 (Summary)

WF Remote Daemonは、GitHub Issueのコメントをポーリングしてワークフローコマンドを検出・実行するバックグラウンドデーモンスクリプトである。`/approve`、`/next`、`/pause`、`/stop`などのコマンドをIssueコメントから読み取り、Claude Code CLIを介してワークフローステップを自動実行する。リモートからのワークフロー制御を可能にし、非対話的な自動化を実現する。

## 評価 (Evaluation)

### 品質 (Quality)

- [x] **完全性 (Completeness)**: 必要な情報が網羅されている
- [x] **明確性 (Clarity)**: 読者にとって分かりやすい
- [x] **一貫性 (Consistency)**: 用語・スタイルが統一されている

### 技術的正確性 (Technical Accuracy)

- [x] **情報の正確性 (Correct information)**: 記載内容が正確
- [x] **最新性 (Up-to-date content)**: 情報が最新の状態

## 改善点 (Improvements)

### 優先度高 (High Priority)

| # | 箇所 | 問題 | 提案 | Status |
|---|------|------|------|--------|
| 1 | ヘッダーコメント | 設定可能なパラメータ（`POLL_INTERVAL`、`MAX_STEPS`）の説明がない | 環境変数での上書き方法を含む設定ドキュメントを追加 | ✓ Fixed (2026-01-25) |
| 2 | エラーハンドリング | `remote-utils.sh`が存在しない場合の明示的なエラーメッセージがない | source前にファイル存在チェックを追加し、分かりやすいエラーを出力 | ✓ Fixed (2026-01-25) |
| 3 | セキュリティ | `wf_remote_is_collaborator`チェックはあるが、コマンドインジェクションの可能性 | `WORK_ID`や`SOURCE_ISSUE`のバリデーション強化（数値・英数字チェック等） | ✓ Fixed (2026-01-25) |

### 優先度中 (Medium Priority)

| # | 箇所 | 問題 | 提案 | Status |
|---|------|------|------|--------|
| 1 | 行63-66 | ポーリング状態のログ出力が簡素 | 残りステップ数や経過時間を表示する詳細ログオプションを追加 | ✓ Fixed (2026-01-25) |
| 2 | 行144-150 | `stopped`ステータス確認がループ内で毎回実行される | ステータスチェックをコマンド処理後のみに限定（パフォーマンス改善） | ✓ Fixed (2026-01-25) |
| 3 | 行59 | `LAST_COMMENT_ID`の初期化が空文字列 | 起動時に既存コメントIDを取得して、過去コマンドの再実行を防止 | ✓ Fixed (2026-01-25) |
| 4 | 全体 | シグナルハンドリングがない | `trap`を使用してSIGTERM/SIGINTでのクリーンアップ処理を追加 | ✓ Fixed (2026-01-25) |

### 将来の検討事項 (Future Considerations)

- 複数ワークIDの同時監視機能
- ログファイルへの出力オプション（`--log-file`引数）
- ヘルスチェックエンドポイント（systemd連携用）
- 再接続ロジック（GitHub API一時的エラー時のリトライ）
- コマンド実行履歴の永続化（memory.jsonへの記録）

## 総評 (Overall Assessment)

本スクリプトは、GitHub Issueを介したリモートワークフロー制御という明確な目的を持ち、その機能を適切に実装している。コードは読みやすく、`set -euo pipefail`によるエラー処理、協力者権限チェック、最大ステップ数制限など、基本的なセーフガードが実装されている。

`remote-utils.sh`への依存関係は適切に分離されており、メインロジックがシンプルに保たれている。ポーリングループの構造も明確で、各コマンドタイプの処理が`case`文で整理されている。

改善すべき主な点は、起動時の初期化処理（既存コメントのスキップ）、シグナルハンドリングの追加、および入力バリデーションの強化である。本番環境での長時間運用を想定する場合、ログ出力の充実とエラーリカバリ機能の追加が望ましい。

全体として、プロトタイプレベルから本番運用レベルへの移行に向けて、堅牢性の向上が推奨される。
